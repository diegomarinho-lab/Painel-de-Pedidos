<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    // --- L√ìGICA DO DASHBOARD DE PEDIDOS PENDENTES ---
    // ATEN√á√ÉO: Use a URL de implanta√ß√£o do seu Web App
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyvSqRwhuFoHeFPKpsIY3oCoH0b84_uIkDntZhuAtLsV3XvWlgSKcvfNMyx_KDb5ro/exec';
    const AUTO_REFRESH_MS = 600000; // 10 min
    const LOGO_URL = 'https://www.appsheet.com/fsimage.png?appid=e6dbb840-9231-483a-9c9c-f878f9afa058&datasource=google&filename=DocId%3D1xWPFjq8YL808Dv40uzwimCN0j8-UwwoD&signature=f8b5fd7133e3ad2b0f5f8f16ede0593312d97ed3f9f333f2b8957f84f58c29c4&tableprovider=google&userid=104514639';
    document.getElementById('logoImg' ).src = LOGO_URL;

    let allPedidos = [];
    let activeCategory = 'Atrasados';
    let activeDivisions = new Set();
    let categoryCounts = {}; // Armazena a contagem total por categoria (Atrasados, Para Hoje, Futuros)

    function formatDateIsoToBr(iso) {
        if (!iso) return '-';
        const parts = iso.split('-');
        if (parts.length === 3) {
            const [y, m, d] = parts;
            return `${d}/${m}/${y}`;
        }
        return iso;
    }

    function stageClass(stage, index) {
        if (stage >= 3 && index === 3) return 'active-3';
        if (stage >= 2 && index === 2) return 'active-2';
        if (stage >= 1 && index === 1) return 'active-1';
        return '';
    }

    function badge(cat) {
        if (cat === 'Atrasados') return '<span class="badge badge-danger">Atrasados</span>';
        if (cat === 'Para Hoje') return '<span class="badge badge-warn">Para Hoje</span>';
        return '<span class="badge badge-ok">Futuros</span>';
    }

    // NOVO: Fun√ß√£o de callback global para JSONP
    window.handleGasResponse = function(data) {
        // Esta fun√ß√£o √© chamada automaticamente quando o GAS retorna os dados
        
        // Remove o script tag injetado
        const script = document.getElementById('gasScript');
        if (script) script.remove();
        
        // Chama a fun√ß√£o principal de carregamento
        loadDataAndProcess(data);
    }

    // NOVO: Fun√ß√£o para carregar dados usando JSONP
    function fetchData() {
        return new Promise((resolve, reject) => {
            const meta = document.getElementById('meta');
            
            // 1. Define a URL com o par√¢metro 'callback'
            const url = WEB_APP_URL + '?callback=handleGasResponse';
            
            // 2. Cria um novo elemento script
            const script = document.createElement('script');
            script.src = url;
            script.id = 'gasScript';
            
            // 3. Define um timeout para caso a requisi√ß√£o falhe
            const timeout = setTimeout(() => {
                script.remove();
                meta.textContent = `ERRO CR√çTICO: Timeout ao carregar dados do Google Apps Script.`;
                document.getElementById('sections').innerHTML = `<div style="padding: 20px; color: var(--danger-tx); background: var(--danger-bg); border-radius: 8px;">
                    N√£o foi poss√≠vel carregar os dados. Detalhes do Erro: Timeout ao carregar dados do Google Apps Script.
                    <p style="margin-top: 10px; font-size: 13px;">Verifique se o Web App (URL: ${WEB_APP_URL}) foi publicado corretamente e se possui permiss√£o de acesso "Qualquer pessoa".</p>
                </div>`;
                reject(new Error('Timeout ao carregar dados do Google Apps Script.'));
            }, 30000); // 30 segundos de timeout
            
            // 4. Sobrescreve a fun√ß√£o original loadDataAndProcess para usar os dados do JSONP
            window.loadDataAndProcess = function(data) {
                clearTimeout(timeout);
                
                if (data?.error) {
                    const errorMsg = data.message || 'Erro de backend no GAS. Verifique os logs.';
                    meta.textContent = `ERRO CR√çTICO: ${errorMsg}`;
                    document.getElementById('sections').innerHTML = `<div style="padding: 20px; color: var(--danger-tx); background: var(--danger-bg); border-radius: 8px;">
                        N√£o foi poss√≠vel carregar os dados. Detalhes do Erro: ${errorMsg}
                        <p style="margin-top: 10px; font-size: 13px;">Verifique se o Web App (URL: ${WEB_APP_URL}) foi publicado corretamente e se possui permiss√£o de acesso "Qualquer pessoa".</p>
                    </div>`;
                    reject(new Error(errorMsg));
                } else {
                    resolve(data);
                }
            };
            
            // 5. Adiciona o script ao corpo do documento para iniciar a requisi√ß√£o
            document.body.appendChild(script);
        });
    }

    function renderCard(p) {
        const card = document.createElement('div');
        card.className = 'card';
        if (p.faturadoNumero) card.classList.add('faturado');

        const header = document.createElement('div');
        header.className = 'card-header';
        header.innerHTML = `
            <div>
                <div class="card-title">Pedido #${p.pedido}</div>
                <div class="card-sub">Cliente: ${p.cliente || '-'}</div>
                <div class="card-sub">Divis√£o: ${p.divisao || '-'}</div>
                <div class="card-sub">Entrega: ${formatDateIsoToBr(p.entregaDate) || '-'}</div>
                ${p.faturadoNumero ? `<div class="card-sub" style="color:var(--accent);font-weight:700">Faturado: ${String(p.faturadoNumero).padStart(9, '0')}</div>` : ''}
                
                ${p.vendedora ? `<div class="card-sub">Vendas: ${p.vendedora}</div>` : ''}
                ${p.tipoEntrega ? `<div class="card-sub">Tipo de Entrega: ${p.tipoEntrega}</div>` : ''}
                ${p.observacoes ? `<div class="card-sub">Observa√ß√µes: ${p.observacoes}</div>` : ''}
            </div>
            <div>${badge(p.categoria)}</div>
        `;

        const body = document.createElement('div');
        body.className = 'card-body';
        body.innerHTML = `
            <div class="progress">
                <div class="stage ${stageClass(p.stage, 1)}"></div>
                <div class="stage ${stageClass(p.stage, 2)}"></div>
                <div class="stage ${stageClass(p.stage, 3)}"></div>
            </div>
            <div class="stage-labels">
                <div>A Liberar</div><div>Liberado</div><div>Faturado</div>
            </div>
        `;

        (p.items || []).forEach(it => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item';

            const top = document.createElement('div');
            top.className = 'item-top';
            top.innerHTML = `
                <div class="item-name">${it?.itemDesc || '(Sem descri√ß√£o)'}</div>
                <div class="item-code">C√≥digo: ${it?.itemCode || '-'}</div>
            `;

            const statuses = document.createElement('div');
            statuses.className = 'status-row';
            statuses.innerHTML = `
                <div class="status-col"><b>HOJE:</b> ${it?.statusHoje || '-'}</div>
                <div class="status-col"><b>ONTEM:</b> ${it?.statusOntem || '-'}</div>
                <div class="status-col"><b>ANTEONTEM:</b> ${it?.statusAnteontem || '-'}</div>
                <div class="status-col"><b>FALTA DE MP:</b> ${it?.statusFaltaMp || '-'}</div>
            `;

            itemDiv.appendChild(top);
            itemDiv.appendChild(statuses);
            body.appendChild(itemDiv);
        });

        card.appendChild(header);
        card.appendChild(body);
        return card;
    }

    // Novo: Fun√ß√£o para atualizar a contagem nos bot√µes
    function updateFilterButtons() {
        document.getElementById('btn-Atrasados').textContent = `Atrasados ${categoryCounts['Atrasados'] || 0}`;
        document.getElementById('btn-Para Hoje').textContent = `Para Hoje ${categoryCounts['Para Hoje'] || 0}`;
        document.getElementById('btn-Futuros').textContent = `Futuros ${categoryCounts['Futuros'] || 0}`;
    }

    function render(searchTerm = '') {
        const dashboardVisible = document.getElementById('dashboardContent').style.display !== 'none';
        
        const meta = document.getElementById('meta');
        const sections = document.getElementById('sections');
        
        if (dashboardVisible) {
            sections.innerHTML = '';
            
            let filtered = allPedidos.filter(p => p.categoria === activeCategory);

            // Busca por Pedido, Cliente, Divis√£o ou Item
            if (searchTerm) {
                const t = searchTerm.toLowerCase();
                filtered = filtered.filter(p => {
                    // 1. Busca nos campos principais (Pedido, Cliente, Divis√£o)
                    if (
                        String(p.pedido).toLowerCase().includes(t) ||
                        (p.cliente || '').toLowerCase().includes(t) ||
                        (p.divisao || '').toLowerCase().includes(t)
                    ) {
                        return true;
                    }

                    // 2. Busca nos itens do pedido
                    if (p.items && p.items.length > 0) {
                        return p.items.some(item => 
                            (item.itemDesc || '').toLowerCase().includes(t) ||
                            (item.itemCode || '').toLowerCase().includes(t)
                        );
                    }
                    return false;
                });
            }

            // Filtra por divis√µes
            if (activeDivisions.size > 0) {
                filtered = filtered.filter(p => p.divisao && activeDivisions.has(String(p.divisao).trim()));
            }
            
            const grid = document.createElement('div');
            grid.className = 'grid';
            filtered.forEach(p => grid.appendChild(renderCard(p)));
            sections.appendChild(grid);
            
            meta.textContent = `Atualizado: ${new Date().toLocaleString()} ‚Ä¢ Categoria: ${activeCategory} ‚Ä¢ Exibindo: ${filtered.length}`;
        } else {
            meta.textContent = `Atualizado: ${new Date().toLocaleString()} ‚Ä¢ Carregamento em segundo plano.`;
        }
        
        updateFilterButtons(); 
    }

    // NOVO: Fun√ß√£o que processa os dados e renderiza (antiga loadAndRender)
    function processDataAndRender(data) {
        const meta = document.getElementById('meta');
        
        allPedidos = data?.pedidos || [];
        
        // 1. Calcular contagem total por categoria (para os bot√µes)
        categoryCounts = { 'Atrasados': 0, 'Para Hoje': 0, 'Futuros': 0 };
        allPedidos.forEach(p => {
            categoryCounts[p.categoria] = (categoryCounts[p.categoria] || 0) + 1;
        });

        // 2. Popular filtros de divis√£o
        const divs = Array.from(new Set(allPedidos.map(p => (p.divisao || '').trim()).filter(Boolean))).sort();
        const filtersEl = document.getElementById('divisionFilters');
        filtersEl.innerHTML = '';
        activeDivisions = new Set();
        divs.forEach(div => {
            const id = `div-${div.replace(/\s+/g, '_')}`;
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" id="${id}" value="${div}"> ${div}`;
            filtersEl.appendChild(label);
            label.querySelector('input').addEventListener('change', (e) => {
                const val = e.target.value;
                if (e.target.checked) activeDivisions.add(val);
                else activeDivisions.delete(val);
                render(document.getElementById('searchInput').value);
            });
        });

        meta.textContent = `Atualizado: ${new Date(data.updatedAt).toLocaleString()} ‚Ä¢ Total: ${data.totalPedidos}`;
        render(document.getElementById('searchInput').value);
    }

    // NOVO: Fun√ß√£o que inicia o carregamento (substitui a loadAndRender original)
    async function loadAndRender() {
        const meta = document.getElementById('meta');
        meta.textContent = 'Carregando...';
        try {
            // fetchData agora usa JSONP e resolve com os dados
            const data = await fetchData();
            // processDataAndRender √© chamada dentro de handleGasResponse
            // Mas para o caso de sucesso do Promise, chamamos aqui
            processDataAndRender(data);
        } catch (err) {
            // Erro j√° tratado e reportado em fetchData
            console.error("Erro final no carregamento:", err);
        }
    }

    // Busca
    document.getElementById('searchInput').addEventListener('input', (e) => {
        render(e.target.value);
    });

    // Filtros de categoria
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            activeCategory = btn.dataset.cat;
            render(document.getElementById('searchInput').value);
        });
    });

    // Bot√£o atualizar
    document.getElementById('refreshBtn').addEventListener('click', loadAndRender);

    // Primeira carga e auto-refresh
    loadAndRender();
    setInterval(loadAndRender, AUTO_REFRESH_MS);


    // --- L√ìGICA DE ALTERN√ÇNCIA DE VIEW ---
    function toggleView(view) {
        const dashboard = document.getElementById('dashboardContent');
        const tracker = document.getElementById('trackerContent');
        const trackerLink = document.getElementById('trackerLink');
        
        if (view === 'dashboard') {
            dashboard.style.display = 'block'; 
            tracker.style.display = 'none';
            trackerLink.style.background = 'var(--primary)'; // Cor inativa
            render(document.getElementById('searchInput').value); // For√ßa render no retorno
        } else if (view === 'tracker') {
            dashboard.style.display = 'none';
            tracker.style.display = 'block';
            trackerLink.style.background = 'var(--accent)'; // Cor ativa
        }
    }


    // --- L√ìGICA DO RASTREADOR DE PEDIDOS (RENOMEADA PARA EVITAR CONFLITO) ---
    const RASTREADOR_WEB_APP_URL = 'https://script.google.com/a/macros/doremus.com.br/s/AKfycbxTGO3RP3O8EgJ9CL_Y4PaoEbqjnLgHG8Mr1vP_aCQscMWY0pdNQ_U7IN8NysDNMrD9/exec';
    
    let ultimoResultado = null;
    let ultimoNumeroPedido = null;
    let itensDoPedido = [];

    function rastreadorBuscarPedido( ) {
        const orderNumber = document.getElementById('orderNumber').value.trim();
        
        if (!orderNumber) {
            rastreadorMostrarErro('Por favor, digite um n√∫mero de pedido');
            return;
        }
        
        ultimoNumeroPedido = orderNumber;
        rastreadorMostrarCarregando('Buscando itens do pedido...');
        
        fetch(RASTREADOR_WEB_APP_URL + '?action=listarItens&numero=' + encodeURIComponent(orderNumber))
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.status);
                }
                return response.json();
            })
            .then(resultado => rastreadorProcessarListaItens(resultado))
            .catch(erro => rastreadorMostrarErro('Erro ao conectar ao servidor: ' + erro.message));
    }

    function rastreadorProcessarListaItens(resultado) {
        const resultsDiv = document.getElementById('trackerResults');

        if (resultado.erro) {
            rastreadorMostrarErro(resultado.erro);
            document.getElementById('itemSelectionContainer').style.display = 'none';
            return;
        }

        itensDoPedido = resultado.itens || [];
        ultimoResultado = resultado;

        let infoHtml = '<div class="success">‚úÖ Pedido encontrado! Selecione os itens para rastrear.</div>';
        infoHtml += '<div class="order-info">';
        infoHtml += '<div class="info-row">';
        infoHtml += '<div class="info-item">';
        infoHtml += '<div class="info-label">N√∫mero do Pedido</div>';
        infoHtml += '<div class="info-value">' + resultado.numero + '</div>';
        infoHtml += '</div>';
        infoHtml += '<div class="info-item">';
        infoHtml += '<div class="info-label">Cliente</div>';
        infoHtml += '<div class="info-value">' + resultado.cliente + '</div>';
        infoHtml += '</div>';
        infoHtml += '</div>';
        infoHtml += '<div class="info-row">';
        infoHtml += '<div class="info-item">';
        infoHtml += '<div class="info-label">Data de Entrega Prevista</div>';
        infoHtml += '<div class="info-value">' + resultado.entrega + '</div>';
        infoHtml += '</div>';
        infoHtml += '</div>';
        infoHtml += '</div>';
        
        resultsDiv.innerHTML = infoHtml;
        resultsDiv.classList.add('show');
        document.getElementById('downloadGroup').style.display = 'none';

        const itemListDiv = document.getElementById('itemList');
        itemListDiv.innerHTML = '';
        itensDoPedido.forEach((item, index) => {
            itemListDiv.innerHTML += `
                <label>
                    <input type="checkbox" name="item" value="${item}" checked>
                    ${item}
                </label>
            `;
        });

        document.getElementById('itemSelectionContainer').style.display = 'block';
    }

    function rastreadorRastrearItens() {
        const selectedItems = Array.from(document.querySelectorAll('#itemList input[name="item"]:checked'))
                                   .map(checkbox => checkbox.value);

        if (selectedItems.length === 0) {
            rastreadorMostrarErro('Por favor, selecione pelo menos um item para rastrear.');
            return;
        }

        rastreadorMostrarCarregando('Rastreando status dos itens selecionados...');

        fetch(RASTREADOR_WEB_APP_URL + '?action=buscarStatus&numero=' + encodeURIComponent(ultimoNumeroPedido) + '&itens=' + encodeURIComponent(JSON.stringify(selectedItems)))
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na resposta do servidor: ' + response.status);
                }
                return response.json();
            })
            .then(resultado => rastreadorMostrarResultado(resultado))
            .catch(erro => rastreadorMostrarErro('Erro ao conectar ao servidor: ' + erro.message));
    }
    
    function rastreadorMostrarCarregando(mensagem) {
        const resultsDiv = document.getElementById('trackerResults');
        resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>' + mensagem + '</div>';
        resultsDiv.classList.add('show');
        document.getElementById('itemSelectionContainer').style.display = 'none';
        document.getElementById('downloadGroup').style.display = 'none';
    }
    
    function rastreadorMostrarResultado(resultado) {
        const resultsDiv = document.getElementById('trackerResults');
        
        if (resultado.erro) {
            resultsDiv.innerHTML = '<div class="error">‚ùå ' + resultado.erro + '</div>';
            resultsDiv.classList.add('show');
            document.getElementById('downloadGroup').style.display = 'none';
            return;
        }
        
        ultimoResultado.itensSelecionados = resultado.itensSelecionados;
        ultimoResultado.atualizacoesAgrupadas = resultado.atualizacoesAgrupadas;

        const itensExibicao = resultado.itensSelecionados.join('; ');

        let html = '<div class="success">‚úÖ Rastreamento conclu√≠do para: ' + itensExibicao + '</div>';
        
        html += '<div class="order-info">';
        html += '<div class="info-row">';
        html += '<div class="info-item">';
        html += '<div class="info-label">N√∫mero do Pedido</div>';
        html += '<div class="info-value">' + ultimoResultado.numero + '</div>';
        html += '</div>';
        html += '<div class="info-item">';
        html += '<div class="info-label">Cliente</div>';
        html += '<div class="info-value">' + ultimoResultado.cliente + '</div>';
        html += '</div>';
        html += '</div>';
        
        html += '<div class="info-row">';
        html += '<div class="info-item">';
        html += '<div class="info-label">Data de Entrega Prevista</div>';
        html += '<div class="info-value">' + ultimoResultado.entrega + '</div>';
        html += '</div>';
        html += '<div class="info-item">';
        html += '<div class="info-label">Itens Rastreando</div>';
        html += '<div class="info-value">' + itensExibicao + '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        
        html += '<div class="timeline">';
        html += '<div class="timeline-title">üìÖ Hist√≥rico de Atualiza√ß√µes</div>';
        
        const itensAgrupados = resultado.atualizacoesAgrupadas;
        const itensOrdenados = Object.keys(itensAgrupados).sort();

        if (itensOrdenados.length === 0) {
            html += '<p>Nenhuma atualiza√ß√£o de status encontrada para os itens selecionados.</p>';
        } else {
            itensOrdenados.forEach(function(item) {
                const atualizacoes = itensAgrupados[item];
                
                html += '<h3 class="item-timeline-title">Item: ' + item + '</h3>';

                atualizacoes.forEach(function(atualizacao) {
                    const classe = atualizacao.atrasado ? 'atrasado' : (atualizacao.entregue ? 'entregue' : '');
                    const badge = atualizacao.atrasado ? '<span class="tracker-badge badge-atrasado">ATRASADO</span>' : (atualizacao.entregue ? '<span class="tracker-badge badge-entregue">ENTREGUE</span>' : '');
                    
                    html += '<div class="timeline-item ' + classe + '">';
                    html += '<div class="timeline-status">' + atualizacao.status + badge + '</div>';
                    html += '<div class="timeline-previsao">' + atualizacao.previsao + '</div>';
                    html += '<div class="timeline-motivo">Motivo: ' + atualizacao.motivo + '</div>';
                    html += '<div class="timeline-data">' + atualizacao.data + '</div>';
                    html += '</div>';
                });
            });
        }
        
        html += '</div>';
        
        resultsDiv.innerHTML = html;
        resultsDiv.classList.add('show');
        document.getElementById('downloadGroup').style.display = 'flex';
        document.getElementById('itemSelectionContainer').style.display = 'none';
    }
    
    function rastreadorMostrarErro(erro) {
        const resultsDiv = document.getElementById('trackerResults');
        resultsDiv.innerHTML = '<div class="error">‚ùå Erro: ' + erro + '</div>';
        resultsDiv.classList.add('show');
        document.getElementById('itemSelectionContainer').style.display = 'none';
        document.getElementById('downloadGroup').style.display = 'none';
    }
    
    function rastreadorLimpar() {
        document.getElementById('orderNumber').value = '';
        document.getElementById('trackerResults').innerHTML = '';
        document.getElementById('trackerResults').classList.remove('show');
        document.getElementById('downloadGroup').style.display = 'none';
        document.getElementById('itemSelectionContainer').style.display = 'none';
        document.getElementById('orderNumber').focus();
        ultimoResultado = null;
        ultimoNumeroPedido = null;
        itensDoPedido = [];
    }
    
    function rastreadorBaixarPDF() {
        if (!ultimoResultado || !ultimoResultado.atualizacoesAgrupadas) {
            rastreadorMostrarErro('Nenhum resultado para baixar. Por favor, rastreie um pedido primeiro.');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();
        const margin = 15;
        const lineHeight = 7;
        let yPosition = margin;
        
        const corPrimaria = [0, 71, 171];
        const corSecundaria = [204, 0, 0];
        const corTexto = [51, 51, 51];
        const corTextoClaro = [153, 153, 153];
        
        doc.setFillColor(...corPrimaria);
        doc.rect(0, 0, pageWidth, 30, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.text('RASTREADOR DE PEDIDOS', margin + 5, 15);
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text('Relat√≥rio de Acompanhamento', margin + 5, 23);
        
        yPosition = 40;
        
        doc.setTextColor(...corPrimaria);
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('INFORMA√á√ïES DO PEDIDO', margin, yPosition);
        yPosition += 8;
        
        doc.setTextColor(...corTexto);
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        
        const infoData = [
            ['N√∫mero do Pedido:', ultimoResultado.numero],
            ['Cliente:', ultimoResultado.cliente],
            ['Data de Entrega Prevista:', ultimoResultado.entrega],
            ['Itens Rastreados:', ultimoResultado.itensSelecionados.join(', ')]
        ];
        
        infoData.forEach(([label, value]) => {
            if (yPosition > pageHeight - margin - 20) {
                doc.addPage();
                yPosition = margin;
            }
            
            doc.setFont(undefined, 'bold');
            doc.setTextColor(...corPrimaria);
            doc.text(label, margin, yPosition);
            
            doc.setFont(undefined, 'normal');
            doc.setTextColor(...corTexto);
            const textWidth = pageWidth - (margin * 2) - 60;
            const splitText = doc.splitTextToSize(value, textWidth);
            doc.text(splitText, margin + 60, yPosition);
            
            yPosition += lineHeight + 2;
        });
        
        yPosition += 5;
        
        Object.keys(ultimoResultado.atualizacoesAgrupadas).forEach(item => {
            if (yPosition > pageHeight - margin - 15) {
                doc.addPage();
                yPosition = margin;
            }
            
            doc.setTextColor(...corPrimaria);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Item: ' + item, margin, yPosition);
            yPosition += 8;
            
            ultimoResultado.atualizacoesAgrupadas[item].forEach(atualizacao => {
                if (yPosition > pageHeight - margin - 15) {
                    doc.addPage();
                    yPosition = margin;
                }
                
                doc.setFillColor(...corPrimaria);
                doc.circle(margin + 5, yPosition + 2, 2.5, 'F');
                
                doc.setFont(undefined, 'bold');
                doc.setTextColor(...corTexto);
                doc.setFontSize(10);
                let statusText = atualizacao.status;
                if (atualizacao.atrasado) statusText += ' [ATRASADO]';
                else if (atualizacao.entregue) statusText += ' [ENTREGUE]';
                doc.text(statusText, margin + 12, yPosition + 2);
                
                yPosition += 5;
                
                doc.setFont(undefined, 'normal');
                doc.setTextColor(...corTextoClaro);
                doc.setFontSize(9);
                doc.text('Previs√£o: ' + atualizacao.previsao, margin + 12, yPosition);
                yPosition += 4;
                
                const motivoText = doc.splitTextToSize('Motivo: ' + atualizacao.motivo, pageWidth - (margin * 2) - 12);
                doc.text(motivoText, margin + 12, yPosition);
                yPosition += (motivoText.length * 3) + 2;
                
                doc.setTextColor(200, 200, 200);
                doc.setFontSize(8);
                doc.text('Data: ' + atualizacao.data, margin + 12, yPosition);
                yPosition += 6;
            });
            
            yPosition += 5;
        });
        
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setTextColor(200, 200, 200);
            doc.setFontSize(8);
            doc.text(
                'P√°gina ' + i + ' de ' + totalPages + ' | Gerado em ' + new Date().toLocaleString('pt-BR'),
                margin,
                pageHeight - 8
            );
        }
        
        doc.save('Rastreamento_Pedido_' + ultimoNumeroPedido + '.pdf');
    }
</script>
