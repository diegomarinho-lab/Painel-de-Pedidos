<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Pedidos - Doremus</title>
  <style>
    /* VARS DO DASHBOARD */
    :root {
      --bg: #ffffff;
      --text: #0b1f52;
      --muted: #4b5563;
      --accent: #c81e1e;
      --primary: #1e3a8a;
      --card: #f9fafb;
      --chip: #eef2ff;
      --border: #d1d5db;
      --stage1: #9ca3af;
      --stage2: #60a5fa;   /* Azul mais suave para progresso 'Liberado' */
      --stage3: #16a34a;
      
      /* Cores de alerta */
      --danger-bg: #fee2e2; --danger-tx: #b91c1c;
      --warn-bg: #fef3c7;   --warn-tx: #b45309;
      --ok-bg: #dcfce7;     --ok-tx: #166534;

      /* NOVAS CORES DE FUNDO */
      --liberado-bg: #e6f7ff; /* Azul muito claro (Levemente azulado) */
      --liberado-border: #a8d5ff; /* Borda levemente azul */
      
      /* NOVAS CORES PARA CARD ATIVO (Conforme solicita√ß√£o 2, 3 e 4) */
      --active-atrasados: var(--danger-tx); /* Vermelho Escuro */
      --active-hoje: var(--warn-tx);         /* Amarelo/Laranja Escuro */
      --active-futuros: var(--stage3);       /* Verde Escuro */
      
      /* VARS DO RASTREADOR (Adaptadas) */
      --doremus-blue: var(--primary); /* Reutilizando a cor prim√°ria */
      --doremus-red: var(--accent); /* Reutilizando a cor de destaque */
      --doremus-blue-light: #0056CC;
    }

    html, body {
      margin: 0; padding: 0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
    }

    .layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      min-height: 100vh;
    }

    /* Sidebar fixa */
    .sidebar {
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
      background: #f3f4f6;
      border-right: 1px solid var(--border);
      padding: 16px;
      /* Novo estilo para empurrar o rodap√© para baixo */
      display: flex;
      flex-direction: column; 
    }
    .sidebar .logo {
      display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
    }
    .sidebar h3 { font-size: 14px; margin: 0 0 8px 0; color: var(--primary); }
    .sidebar label {
      display: flex; align-items: center; gap: 8px;
      margin-bottom: 8px; font-size: 13px; color: var(--muted);
      cursor: pointer;
    }
    .sidebar input[type="checkbox"] { transform: scale(1.1); }
    
    /* Novo estilo para o rodap√© da sidebar */
    .sidebar-footer {
        margin-top: auto; /* Empurra para o final */
        padding-top: 15px;
        border-top: 1px solid var(--border);
        font-size: 11px;
        color: var(--muted);
        text-align: center;
    }
    
    /* Estilo para o menu suspenso na sidebar (Vendedora) */
    .sidebar select {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 13px;
        color: var(--text);
        background: #fff;
        margin-bottom: 15px;
        cursor: pointer;
    }
    
    /* Estilos para o novo filtro de est√°gios (radios) */
    .stage-filters {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
    }
    .stage-filters label {
        display: block;
        margin-bottom: 4px;
        font-size: 13px;
        color: var(--muted);
        cursor: pointer;
    }
    .stage-filters input[type="radio"] {
        transform: scale(1.1);
        margin-right: 8px;
    }


    header {
      position: sticky; top: 0; z-index: 10;
      background: #ffffff; border-bottom: 1px solid var(--border);
    }
    .header-row {
      display: flex; align-items: center; justify-content: space-between;
      gap: 16px; flex-wrap: wrap; padding: 16px 20px;
    }
    .title { font-weight: 800; font-size: 18px; color: var(--primary); }
    .meta { font-size: 12px; color: var(--muted); }
    .btn {
      background: var(--accent); color: #fff; border: none;
      padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;
    }

    /* Barra de pesquisa (agora fixa no header) */
    .search-bar {
      display: flex; justify-content: center; padding: 12px;
      background: #fafafa;
    }
    .search-bar input {
      width: 60%; max-width: 500px;
      padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;
    }

    /* NOVOS ESTILOS PARA CARDS DE CONTAGEM (HEADER) */
    .count-cards-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding: 10px 20px 20px;
        background: #fafafa;
        border-bottom: 1px solid var(--border);
    }
    .count-card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .count-card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }
    
    /* 2, 3, 4. Cores do card ativo */
    .count-card.active-Atrasados {
        background: var(--danger-bg);
        color: var(--active-atrasados);
        border-color: var(--active-atrasados);
        box-shadow: 0 4px 8px rgba(185, 28, 28, 0.2);
    }
    .count-card.active-ParaHoje {
        background: var(--warn-bg);
        color: var(--active-hoje);
        border-color: var(--active-hoje);
        box-shadow: 0 4px 8px rgba(180, 83, 9, 0.2);
    }
    .count-card.active-Futuros {
        background: var(--ok-bg);
        color: var(--active-futuros);
        border-color: var(--active-futuros);
        box-shadow: 0 4px 8px rgba(22, 163, 74, 0.2);
    }
    
    .count-card-header {
        display: flex;
        align-items: center;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--muted); /* Padr√£o inativo */
    }
    /* Corrigir cor do header do card ativo */
    .count-card.active-Atrasados .count-card-header { color: var(--active-atrasados); }
    .count-card.active-ParaHoje .count-card-header { color: var(--active-hoje); }
    .count-card.active-Futuros .count-card-header { color: var(--active-futuros); }


    .count-card-header .icon {
        font-size: 16px;
        margin-right: 6px;
        /* Cores do √≠cone padr√£o */
        color: inherit; 
    }
    
    .count-card-value {
        font-size: 28px;
        font-weight: 800;
        line-height: 1;
        color: var(--text); /* Padr√£o inativo */
    }
    /* Corrigir cor do valor do card ativo */
    .count-card.active-Atrasados .count-card-value { color: var(--active-atrasados); }
    .count-card.active-ParaHoje .count-card-value { color: var(--active-hoje); }
    .count-card.active-Futuros .count-card-value { color: var(--active-futuros); }


    main { padding: 16px 20px; }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(240px, 1fr));
      gap: 12px;
    }

    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px;
      display: flex; flex-direction: column; height: 400px; overflow: hidden;
    }
    /* 1. Fundo levemente azulado quando liberado */
    .card.liberado {
      background: var(--liberado-bg);
      border-color: var(--liberado-border);
    }
    /* Fundo verde quando faturado */
    .card.faturado {
      background: #ecfdf5;
      border-color: #a7f3d0;
    }

    .card-header {
      padding: 12px; border-bottom: 1px solid var(--border);
      display: grid; grid-template-columns: 1fr auto; gap: 10px;
    }
    .card-title { font-weight: 700; font-size: 14px; color: var(--primary); }
    .card-sub { font-size: 12px; color: var(--muted); }
    .badge { padding: 4px 8px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .badge-danger { background: var(--danger-bg); color: var(--danger-tx); }
    .badge-warn   { background: var(--warn-bg);   color: var(--warn-tx); }
    .badge-ok     { background: var(--ok-bg);     color: var(--ok-tx); }

    .card-body {
      flex: 1; padding: 12px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;
    }

    /* Estilos para informa√ß√µes adicionais (Vendedora, Tipo Coleta, Obs) */
    .order-meta-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        font-size: 12px;
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 1px dashed var(--border);
    }
    .order-meta-info div {
        color: var(--muted);
    }
    .order-meta-info b {
        color: var(--text);
        font-weight: 600;
    }
    
    /* Destaque para Observa√ß√µes */
    .order-meta-obs {
        grid-column: span 2;
        padding: 5px 10px;
        border-radius: 4px;
        background: var(--warn-bg);
        color: var(--warn-tx);
        font-weight: 600;
        font-size: 12px;
    }


    .progress { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
    .stage { height: 8px; border-radius: 6px; background: #e5e7eb; }
    .stage.active-1 { background: var(--stage1); }
    .stage.active-2 { background: var(--stage2); }
    .stage.active-3 { background: var(--stage3); }
    .stage-labels { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; font-size: 11px; color: var(--muted); }

    .item { padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: #fff; }
    .item-top { display: flex; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
    .item-name { font-weight: 600; font-size: 13px; color: var(--primary); }
    .item-code { font-size: 12px; color: var(--muted); }
    .status-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 6px; }
    .status-col { font-size: 12px; color: var(--muted); }
    .status-col b { color: var(--text); font-weight: 700; }

    .footer {
      padding: 12px 20px; text-align: center; color: var(--muted); font-size: 12px; border-top: 1px solid var(--border);
    }

    /* ESTILOS DO RASTREADOR DE PEDIDOS (MANTIDOS) */
    /* ... (Estilos do Rastreador de Pedidos, omitidos para brevidade, mas intactos) ... */
    .tracker-wrapper { padding: 16px 20px; }
    .tracker-container { background: white; border-radius: 12px; box-shadow: 0 0 20px rgba(0,0,0,0.1); overflow: hidden; max-width: 700px; margin: 0 auto; min-height: calc(100vh - 40px); }
    .tracker-header { background: linear-gradient(135deg, var(--doremus-blue-light) 0%, var(--doremus-blue) 100%); color: white; padding: 30px; text-align: center; }
    .tracker-header h1 { font-size: 28px; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; justify-content: center; }
    .tracker-header p { font-size: 14px; opacity: 0.9; }
    .tracker-content { padding: 30px; }
    .tracker-form-group { margin-bottom: 20px; }
    .tracker-content label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; }
    .tracker-content input[type="text"] { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; transition: all 0.3s ease; }
    .tracker-content input[type="text"]:focus { outline: none; border-color: var(--doremus-blue); box-shadow: 0 0 0 3px rgba(0, 71, 171, 0.1); }
    .tracker-button-group { display: flex; gap: 10px; margin-top: 25px; }
    .tracker-content button { flex: 1; padding: 12px 20px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .btn-search { background: linear-gradient(135deg, var(--doremus-blue-light) 0%, var(--doremus-blue) 100%); color: white; }
    .btn-search:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0, 71, 171, 0.3); }
    .btn-search:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-clear { background: #f0f0f0; color: #333; }
    .btn-clear:hover { background: #e0e0e0; }
    .btn-download { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; }
    .btn-download:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3); }
    .tracker-results { margin-top: 30px; display: none; }
    .tracker-results.show { display: block; }
    .error { background: #fee; border-left: 4px solid var(--doremus-red); padding: 15px; border-radius: 4px; color: var(--doremus-red); margin-bottom: 20px; }
    .success { background: #efe; border-left: 4px solid #4f4; padding: 15px; border-radius: 4px; color: #3a3; margin-bottom: 20px; }
    .order-info { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e0e0e0; }
    .info-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
    .info-row:last-child { margin-bottom: 0; }
    .info-item { padding: 10px 0; }
    .info-label { font-size: 12px; font-weight: 600; color: #999; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
    .info-value { font-size: 16px; font-weight: 600; color: #333; word-break: break-word; }
    .timeline { margin-top: 20px; }
    .timeline-title { font-size: 16px; font-weight: 600; color: var(--doremus-blue); margin-bottom: 15px; }
    .item-timeline-title { font-size: 14px; font-weight: 700; color: #333; margin-top: 20px; margin-bottom: 10px; padding-left: 10px; border-left: 3px solid var(--doremus-blue); }
    .timeline-item { position: relative; padding-left: 30px; margin-bottom: 20px; padding-bottom: 20px; border-left: 2px solid #e0e0e0; }
    .timeline-item:last-child { border-left: none; }
    .timeline-dot { position: absolute; left: -8px; top: 0; width: 14px; height: 14px; border-radius: 50%; background: var(--doremus-blue); border: 2px solid white; box-shadow: 0 0 0 2px var(--doremus-blue); }
    .timeline-item.atrasado .timeline-dot { background: var(--doremus-red); box-shadow: 0 0 0 2px var(--doremus-red); }
    .timeline-item.entregue .timeline-dot { background: #4f4; box-shadow: 0 0 0 2px #4f4; }
    .timeline-status { font-weight: 600; color: #333; margin-bottom: 4px; font-size: 14px; }
    .timeline-item.atrasado .timeline-status { color: var(--doremus-red); }
    .timeline-item.entregue .timeline-status { color: #4f4; }
    .timeline-previsao { font-size: 13px; color: #666; margin-bottom: 4px; }
    .timeline-motivo { font-size: 13px; color: #999; font-style: italic; }
    .timeline-data { font-size: 12px; color: #999; margin-top: 8px; }
    .tracker-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 8px; text-transform: uppercase; }
    .badge-atrasado { background: #fee; color: var(--doremus-red); }
    .badge-entregue { background: #efe; color: #4f4; }
    .loading { text-align: center; padding: 20px; color: var(--doremus-blue); }
    .spinner { border: 3px solid #f0f0f0; border-top: 3px solid var(--doremus-blue); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .item-selection { margin-top: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background: #f5f5f5; }
    .item-selection label { font-weight: 700; color: #333; margin-bottom: 10px; }
    .item-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
    .item-list input[type="checkbox"] { margin-right: 10px; }
    .item-list label { font-weight: 400; color: #555; cursor: pointer; display: flex; align-items: center; }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="logo">
        <img id="logoImg" src="" alt="Logo Doremus" height="40">
        <span style="font-weight:800; color: var(--primary);">Doremus Alimentos</span>
      </div>
      
      <p style="margin: 16px 0 8px 0;">
        <a href="https://www.appsheet.com/start/c98df043-946e-4d35-a171-89bc9cf3d2e4" target="_blank" style="
          display: block; 
          padding: 8px 12px; 
          background: var(--accent); 
          color: #fff; 
          text-decoration: none; 
          border-radius: 8px; 
          font-weight: 600; 
          font-size: 14px;
          text-align: center;
        ">
          Carteira de Pedidos
        </a>
      </p>
      
      <p style="margin: 8px 0 16px 0;">
        <a href="#" id="trackerLink" onclick="toggleView('tracker')" style="
          display: block; 
          padding: 8px 12px; 
          background: var(--primary); /* Inativo por padr√£o */
          color: #fff; 
          text-decoration: none; 
          border-radius: 8px; 
          font-weight: 600; 
          font-size: 14px;
          text-align: center;
        ">
          Rastreador de Pedidos
        </a>
      </p>

      <h3>Filtrar Vendedora</h3>
      <select id="filterVendedora" onchange="render(document.getElementById('searchInput').value)">
        <option value="">Todas</option>
      </select>
      
      <h3>Filtrar Est√°gio</h3>
      <div id="stageFilters" class="stage-filters">
        <label>
          <input type="radio" name="stage-filter" value="0" checked onchange="setStageFilter(this.value)"> Todos
        </label>
        <label>
          <input type="radio" name="stage-filter" value="1" onchange="setStageFilter(this.value)"> A Liberar
        </label>
        <label>
          <input type="radio" name="stage-filter" value="2" onchange="setStageFilter(this.value)"> Liberados
        </label>
        <label>
          <input type="radio" name="stage-filter" value="3" onchange="setStageFilter(this.value)"> Faturados
        </label>
      </div>

      <h3>Filtrar divis√£o</h3>
      <div id="divisionFilters"></div>
      
      <div class="sidebar-footer">
        Desenvolvido por Diego Marinho<br>
        Controladoria de Vendas
      </div>
    </aside>

    <div id="contentWrapper" style="display:flex; flex-direction:column; width: 100%;">
      
      <div id="dashboardContent" style="width: 100%;">
        <header>
          <div class="header-row">
            <div>
              <div class="title">Painel de Pedidos Pendentes</div>
              <div id="meta" class="meta">Carregando...</div>
            </div>
            <button id="refreshBtn" class="btn">Atualizar</button>
          </div>
          
          <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Buscar pedido, cliente, item ou divis√£o..." />
          </div>

          <div id="countCardsContainer" class="count-cards-container">
            <div id="cardAtrasados" class="count-card" data-cat="Atrasados" onclick="setCategoryFilter('Atrasados')"></div>
            <div id="cardParaHoje" class="count-card" data-cat="Para Hoje" onclick="setCategoryFilter('Para Hoje')"></div>
            <div id="cardFuturos" class="count-card" data-cat="Futuros" onclick="setCategoryFilter('Futuros')"></div>
          </div>
          
        </header>

        <main>
          <div id="sections"></div>
          <div class="footer">
            <span id="footerMeta">Atualiza√ß√µes autom√°ticas a cada 10 minutos.</span>
          </div>
        </main>
      </div>

      <div id="trackerContent" class="tracker-wrapper" style="display:none;">
        <div style="margin-bottom: 20px;">
          <a href="#" onclick="toggleView('dashboard')" style="font-weight: 600; color: var(--primary); text-decoration: none; display: inline-flex; align-items: center; gap: 5px;">
            &#x2190; Voltar para o Painel de Pedidos
          </a>
        </div>
        
        <div class="tracker-container">
          <div class="tracker-header">
            <h1>
              <img src="https://www.appsheet.com/fsimage.png?appid=e6dbb840-9231-483a-9c9c-f878f9afa058&datasource=google&filename=DocId%3D1xWPFjq8YL808Dv40uzwimCN0j8-UwwoD&signature=f8b5fd7133e3ad2b0f5f8f16ede0593312d97ed3f9f333f2b8957f84f58c29c4&tableprovider=google&userid=104514639"¬†
                  alt="Logo Doremus"¬†
                  style="height: 30px; margin-right: 10px; vertical-align: middle;">¬†
              Rastreador de Pedidos
            </h1>
            <p>Consulte o hist√≥rico completo de acompanhamento do seu pedido</p>
            <p style="font-size: 10px;">Desenvolvido por Diego Marinho - Supervisor de Controladoria de Vendas - 2025</p>
          </div>
          
          <div class="tracker-content">
            <div class="tracker-form-group">
              <label for="orderNumber">N√∫mero do Pedido</label>
              <input 
                type="text" 
                id="orderNumber" 
                placeholder="Digite o n√∫mero do pedido (ex: 473457)"
                onkeypress="if(event.key==='Enter') rastreadorBuscarPedido()"
              >
            </div>
            
            <div class="tracker-button-group">
              <button class="btn-search" onclick="rastreadorBuscarPedido()">üîç Pesquisar</button>
              <button class="btn-clear" onclick="rastreadorLimpar()">Limpar</button>
            </div>
            
            <div id="itemSelectionContainer" class="item-selection" style="display: none;">
              <label>Selecione os Itens para Rastrear:</label>
              <div id="itemList" class="item-list">
              </div>
              <div class="tracker-button-group" style="margin-top: 15px;">
                  <button class="btn-search" onclick="rastreadorRastrearItens()">Rastrear Itens Selecionados</button>
              </div>
            </div>

            <div class="tracker-button-group" id="downloadGroup" style="display: none; margin-top: 15px;">
              <button class="btn-download" onclick="rastreadorBaixarPDF()">üì• Baixar PDF</button>
            </div>
            
            <div class="tracker-results" id="trackerResults"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // --- L√ìGICA DO DASHBOARD DE PEDIDOS PENDENTES ---
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyvSqRwhuFoHeFPKpsIY3oCoH0b84_uIkDntZhuAtLsV3XvWlgSKcvfNMyx_KDb5ro/exec';
    const AUTO_REFRESH_MS = 600000; // 10 min
    const LOGO_URL = 'https://www.appsheet.com/fsimage.png?appid=e6dbb840-9231-483a-9c9c-f878f9afa058&datasource=google&filename=DocId%3D1xWPFjq8YL808Dv40uzwimCN0j8-UwwoD&signature=f8b5fd7133e3ad2b0f5f8f16ede0593312d97ed3f9f333f2b8957f84f58c29c4&tableprovider=google&userid=104514639';
    document.getElementById('logoImg').src = LOGO_URL;

    let allPedidos = [];
    let activeCategory = 'Para Hoje'; // DEFINIDO AGORA COMO "PARA HOJE" para come√ßar no centro da tela
    let activeDivisions = new Set();
    let activeStageFilter = '0'; // 0 = Todos, 1 = A Liberar, 2 = Liberado, 3 = Faturado
    
    // Mapeamento para corrigir a exibi√ß√£o do nome da Categoria no frontend
    const CATEGORY_MAP = {
        "Atrasados": "Hoje", // Categoria do backend (Hoje) vira "Atrasados" na exibi√ß√£o
        "Para Hoje": "Futuros", // Categoria do backend (Amanh√£) vira "Para Hoje" na exibi√ß√£o
        "Futuros": "Futuros", // Categoria do backend (Futuros+1) vira "Futuros" na exibi√ß√£o
    };
    
    // Mapeamento Inverso: Usado para o filtro do Header
    const INVERSE_CATEGORY_MAP = {
        "Atrasados": "Atrasados", // Se o usu√°rio clica em 'Atrasados' (Visual), usamos 'Atrasados' (Backend)
        "Para Hoje": "Para Hoje", // Se o usu√°rio clica em 'Para Hoje' (Visual), usamos 'Para Hoje' (Backend)
        "Futuros": "Futuros", // Se o usu√°rio clica em 'Futuros' (Visual), usamos 'Futuros' (Backend)
    };


    function setCategoryFilter(category) {
        // Usa o nome da categoria VISUAL para definir o filtro, mas usa o nome do BACKEND
        // activeCategory = category; // Revertido para usar o nome do backend, mas a l√≥gica de filtro compensa
        activeCategory = INVERSE_CATEGORY_MAP[category] || category; // Usamos o nome de backend para o filtro
        render(document.getElementById('searchInput').value);
    }
    
    function setStageFilter(value) {
        activeStageFilter = value;
        render(document.getElementById('searchInput').value);
    }

    function formatDateIsoToBr(iso) {
      if (!iso) return '-';
      const [y, m, d] = iso.split('-');
      return `${d}/${m}/${y}`;
    }
    function stageClass(stage, index) {
      if (stage >= 3 && index === 3) return 'active-3';
      if (stage >= 2 && index === 2) return 'active-2';
      if (stage >= 1 && index === 1) return 'active-1';
      return '';
    }
    function badge(cat) {
      if (cat === 'Atrasados') return '<span class="badge badge-danger">Atrasados</span>';
      if (cat === 'Para Hoje') return '<span class="badge badge-warn">Para Hoje</span>';
      return '<span class="badge badge-ok">Futuros</span>';
    }

    async function fetchData() {
      // Usando JSONP para evitar problemas de CORS com o GAS
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpCallback_' + Date.now();
        const script = document.createElement('script');
        script.src = WEB_APP_URL + '?callback=' + callbackName;
        
        window[callbackName] = (data) => {
          document.body.removeChild(script);
          delete window[callbackName];
          if (data?.error) {
            reject(new Error(data.message || 'Erro no backend'));
          } else {
            resolve(data);
          }
        };

        script.onerror = () => {
          document.body.removeChild(script);
          delete window[callbackName];
          reject(new Error('Erro ao carregar script do backend.'));
        };

        document.body.appendChild(script);
      });
    }


    function renderCard(p) {
      const card = document.createElement('div');
      card.className = 'card';
      
      // 1. Aplica a classe de fundo azul para pedidos Liberados (stage 2)
      if (p.stage === 2) card.classList.add('liberado');
      // Faturado deve ter prioridade (stage 3)
      if (p.faturadoNumero) card.classList.add('faturado');

      const header = document.createElement('div');
      header.className = 'card-header';
      header.innerHTML = `
        <div>
          <div class="card-title">Pedido #${p.pedido}</div>
          <div class="card-sub">Cliente: ${p.cliente || '-'}</div>
          <div class="card-sub">Divis√£o: ${p.divisao || '-'}</div>
          <div class="card-sub">Entrega: ${formatDateIsoToBr(p.entregaDate) || '-'}</div>
          ${p.faturadoNumero ? `<div class="card-sub" style="color:var(--accent);font-weight:700">Faturado: ${String(p.faturadoNumero).padStart(9, '0')}</div>` : ''}
        </div>
        <div>${badge(p.categoria)}</div>
      `;

      const body = document.createElement('div');
      body.className = 'card-body';
      
      // 2. Adiciona Vendedora, Tipo de Coleta e Observa√ß√µes destacadas
      let metaInfo = `
        <div class="order-meta-info">
          <div>Vendedora: <b>${p.vendedora || '-'}</b></div>
          <div>Tipo Coleta: <b>${p.tipoEntrega || '-'}</b></div>
      `;

      if (p.observacoes) {
          metaInfo += `
            <div class="order-meta-obs">
              ‚ö†Ô∏è Observa√ß√µes: ${p.observacoes}
            </div>
          `;
      }
      metaInfo += `</div>`;
      
      body.innerHTML = metaInfo + `
        <div class="progress">
          <div class="stage ${stageClass(p.stage, 1)}"></div>
          <div class="stage ${stageClass(p.stage, 2)}"></div>
          <div class="stage ${stageClass(p.stage, 3)}"></div>
        </div>
        <div class="stage-labels">
          <div>A Liberar</div><div>Liberado</div><div>Faturado</div>
        </div>
      `;

      (p.items || []).forEach(it => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'item';

        const top = document.createElement('div');
        top.className = 'item-top';
        top.innerHTML = `
          <div class="item-name">${it?.itemDesc || '(Sem descri√ß√£o)'}</div>
          <div class="item-code">C√≥digo: ${it?.itemCode || '-'}</div>
        `;

        const statuses = document.createElement('div');
        statuses.className = 'status-row';
        statuses.innerHTML = `
          <div class="status-col"><b>HOJE:</b> ${it?.statusHoje || '-'}</div>
          <div class="status-col"><b>ONTEM:</b> ${it?.statusOntem || '-'}</div>
          <div class="status-col"><b>ANTEONTEM:</b> ${it?.statusAnteontem || '-'}</div>
          <div class="status-col"><b>FALTA DE MP:</b> ${it?.statusFaltaMp || '-'}</div>
        `;

        itemDiv.appendChild(top);
        itemDiv.appendChild(statuses);
        body.appendChild(itemDiv);
      });

      card.appendChild(header);
      card.appendChild(body);
      return card;
    }
    
    // NOVO: Fun√ß√£o para atualizar o conte√∫do dos cards de contagem (com cores din√¢micas e contagem filtrada)
    function updateCountCards(counts) {
        
        // Mapeamento da CATEGORIA REAL do backend para o NOME VISUAL do frontend
        const VISUAL_CATEGORIES = {
            'Atrasados': { name: 'Atrasados', icon: '&#x26A0;', activeClass: 'active-Atrasados', id: 'cardAtrasados' },
            'Para Hoje': { name: 'Para Hoje', icon: '&#x23F1;', activeClass: 'active-ParaHoje', id: 'cardParaHoje' },
            'Futuros':   { name: 'Futuros',   icon: '&#x2705;', activeClass: 'active-Futuros',   id: 'cardFuturos' }
        };

        // Ordem de exibi√ß√£o desejada: Atrasados, Para Hoje, Futuros
        const order = ['Atrasados', 'Para Hoje', 'Futuros'];

        order.forEach(visualCatName => {
            const cat = VISUAL_CATEGORIES[visualCatName];
            
            // O nome da categoria que vem no objeto 'counts' √© o nome do BACKEND.
            // Devido ao desalinhamento de 1 dia:
            // Se o usu√°rio clica em "Atrasados" (Visual), ele quer os pedidos classificados como "Atrasados" (Backend)
            // Se o usu√°rio clica em "Para Hoje" (Visual), ele quer os pedidos classificados como "Para Hoje" (Backend)
            // Se o usu√°rio clica em "Futuros" (Visual), ele quer os pedidos classificados como "Futuros" (Backend)
            // A chave do count √© igual ao nome visual, mas a contagem j√° est√° filtrada por categoria.

            const card = document.getElementById(cat.id);
            if (!card) return;
            
            const countValue = counts[cat.name] || 0;
            
            card.innerHTML = `
                <div class="count-card-header">
                    <span class="icon">${cat.icon}</span> ${cat.name}
                </div>
                <div class="count-card-value">${countValue}</div>
            `;
            
            // 2, 3, 4. Aplica a classe de cor espec√≠fica se for o filtro ativo
            card.classList.remove('active-Atrasados', 'active-ParaHoje', 'active-Futuros');
            if (activeCategory === cat.name) {
                card.classList.add(cat.activeClass);
            }
        });
    }


    function render(searchTerm = '') {
      // Condi√ß√£o de sa√≠da ajustada: se o dashboard est√° expl√≠citamente escondido, n√£o renderiza.
      if (document.getElementById('dashboardContent').style.display === 'none') return; 
      
      const meta = document.getElementById('meta');
      const sections = document.getElementById('sections');
      sections.innerHTML = '';

      // --- PASSO 1: APLICA FILTROS DE SIDEBAR A TODOS OS PEDIDOS PARA OBTER AS CONTAGENS CORRETAS ---
      let filteredForCounts = allPedidos;
      
      // FILTRO DE VENDEDORA (Menu Suspenso)
      const selectedVendedora = document.getElementById('filterVendedora').value;
      if (selectedVendedora) {
        filteredForCounts = filteredForCounts.filter(p => p.vendedora && String(p.vendedora).trim() === selectedVendedora);
      }
      
      // FILTRO DE DIVIS√ÉO (Checkboxes)
      const todasDivisoes = Array.from(document.querySelectorAll('#divisionFilters input[type="checkbox"]')).map(el => el.value);
      if (activeDivisions.size > 0 && activeDivisions.size < todasDivisoes.length) {
          filteredForCounts = filteredForCounts.filter(p => p.divisao && activeDivisions.has(String(p.divisao).trim()));
      }

      // FILTRO DE EST√ÅGIO (Sidebar)
      const targetStage = parseInt(activeStageFilter); 
      if (targetStage > 0) {
          if (targetStage === 3) {
             filteredForCounts = filteredForCounts.filter(p => p.stage === 3);
          } else if (targetStage === 2) {
             filteredForCounts = filteredForCounts.filter(p => p.stage === 2);
          } else if (targetStage === 1) {
             filteredForCounts = filteredForCounts.filter(p => p.stage === 1);
          }
      }
      
      // --- PASSO 2: CALCULA AS NOVAS CONTAGENS (usa a categoria do backend) ---
      const counts = filteredForCounts.reduce((acc, p) => {
          acc[p.categoria] = (acc[p.categoria] || 0) + 1;
          return acc;
      }, {});
      
      // --- PASSO 3: APLICA O FILTRO FINAL DE CATEGORIA (ATRASADOS/HOJE/FUTUROS) ---
      let filtered = filteredForCounts.filter(p => p.categoria === activeCategory);


      // --- PASSO 4: APLICA FILTRO DE BUSCA (Search Input) ---
      if (searchTerm) {
        const t = searchTerm.toLowerCase();
        filtered = filtered.filter(p => {
          if (
            String(p.pedido).toLowerCase().includes(t) ||
            (p.cliente || '').toLowerCase().includes(t) ||
            (p.divisao || '').toLowerCase().includes(t) ||
            (p.vendedora || '').toLowerCase().includes(t)
          ) {
            return true;
          }
          if (p.items && p.items.length > 0) {
            return p.items.some(item => 
              (item.itemDesc || '').toLowerCase().includes(t) ||
              (item.itemCode || '').toLowerCase().includes(t)
            );
          }
          return false;
        });
      }
      
      // --- PASSO 5: ATUALIZA OS CARDS DE CONTAGEM E A LISTA VIS√çVEL ---
      updateCountCards(counts); // 1. Passa as contagens filtradas
      
      const grid = document.createElement('div');
      grid.className = 'grid';
      filtered.forEach(p => grid.appendChild(renderCard(p)));
      sections.appendChild(grid);

      meta.textContent = `Atualizado: ${new Date().toLocaleString()} ‚Ä¢ Categoria: ${activeCategory} ‚Ä¢ Exibindo: ${filtered.length}`;
    }

    async function loadAndRender() {
      const meta = document.getElementById('meta');
      meta.textContent = 'Carregando...';
      try {
        const data = await fetchData();
        allPedidos = data?.pedidos || [];
        
        // 1. FILTRO DE VENDEDORAS (Menu Suspenso)
        const vendedoras = Array.from(new Set(allPedidos.map(p => (p.vendedora || '').trim()).filter(Boolean))).sort();
        const selectVendedora = document.getElementById('filterVendedora');
        const selectedValue = selectVendedora.value; 
        
        selectVendedora.innerHTML = '<option value="">Todas</option>';
        vendedoras.forEach(vend => {
          const option = document.createElement('option');
          option.value = vend;
          option.textContent = vend;
          selectVendedora.appendChild(option);
        });
        selectVendedora.value = selectedValue; 

        // 2. FILTRO DE DIVIS√ÉO (Checkboxes - MANTIDO)
        const divs = Array.from(new Set(allPedidos.map(p => (p.divisao || '').trim()).filter(Boolean))).sort();
        const divFiltersEl = document.getElementById('divisionFilters');
        const isInitialLoad = divFiltersEl.innerHTML === ''; 
        divFiltersEl.innerHTML = '';
        
        if (isInitialLoad) {
           activeDivisions = new Set(divs); 
           // Define a categoria inicial para 'Atrasados' na primeira carga, se n√£o estiver definida
           // activeCategory = 'Atrasados'; // Vamos deixar a defini√ß√£o inicial acima da fun√ß√£o.
        }
        
        divs.forEach(div => {
          const id = `div-${div.replace(/\s+/g, '_')}`;
          const isChecked = activeDivisions.has(div);
          const label = document.createElement('label');
          label.innerHTML = `<input type="checkbox" id="${id}" value="${div}" ${isChecked ? 'checked' : ''}> ${div}`;
          divFiltersEl.appendChild(label);
          
          label.querySelector('input').addEventListener('change', (e) => {
            const val = e.target.value;
            if (e.target.checked) activeDivisions.add(val);
            else activeDivisions.delete(val);
            render(document.getElementById('searchInput').value);
          });
        });


        meta.textContent = `Atualizado: ${new Date(data.updatedAt).toLocaleString()} ‚Ä¢ Total: ${data.totalPedidos}`;
        
        // 3. Garante que o r√°dio button de est√°gio 'Todos' esteja selecionado na primeira carga
        if (isInitialLoad) {
            activeStageFilter = '0';
            document.querySelector('#stageFilters input[value="0"]').checked = true;
        }

        render(document.getElementById('searchInput').value);
      } catch (err) {
        const sections = document.getElementById('sections');
        const errorDiv = document.createElement('div');
        errorDiv.className = 'empty';
        errorDiv.textContent = err?.message || 'Erro ao carregar dados.';
        sections.innerHTML = '';
        sections.appendChild(errorDiv);
        meta.textContent = 'Erro ao carregar dados.';
      }
    }

    // Busca
    document.getElementById('searchInput').addEventListener('input', (e) => {
      render(e.target.value);
    });

    // Bot√£o atualizar
    document.getElementById('refreshBtn').addEventListener('click', loadAndRender);

    // Primeira carga e auto-refresh
    loadAndRender();
    setInterval(loadAndRender, AUTO_REFRESH_MS);


    // --- L√ìGICA DE ALTERN√ÇNCIA DE VIEW (MANTIDA) ---
    function toggleView(view) {
      const dashboard = document.getElementById('dashboardContent');
      const tracker = document.getElementById('trackerContent');
      const trackerLink = document.getElementById('trackerLink');
      
      if (view === 'dashboard') {
          dashboard.style.display = 'block'; // Usar 'block' para o fluxo normal de layout
          tracker.style.display = 'none';
          trackerLink.style.background = 'var(--primary)'; // Cor inativa
          render(document.getElementById('searchInput').value);
      } else if (view === 'tracker') {
          dashboard.style.display = 'none';
          tracker.style.display = 'block';
          trackerLink.style.background = 'var(--accent)'; // Cor ativa
      }
    }


    // --- L√ìGICA DO RASTREADOR DE PEDIDOS (MANTIDA) ---
    const RASTREADOR_WEB_APP_URL = 'https://script.google.com/a/macros/doremus.com.br/s/AKfycbxTGO3RP3O8EgJ9CL_Y4PaoEbqjnLgHG8Mr1vP_aCQscMWY0pdNQ_U7IN8NysDNMrD9/exec';
    
    let ultimoResultado = null;
    let ultimoNumeroPedido = null;
    let itensDoPedido = [];

    function rastreadorBuscarPedido() {
      const orderNumber = document.getElementById('orderNumber').value.trim();
      
      if (!orderNumber) {
        rastreadorMostrarErro('Por favor, digite um n√∫mero de pedido');
        return;
      }
      
      ultimoNumeroPedido = orderNumber;
      rastreadorMostrarCarregando('Buscando itens do pedido...');
      
      fetch(RASTREADOR_WEB_APP_URL + '?action=listarItens&numero=' + encodeURIComponent(orderNumber))
        .then(response => {
          if (!response.ok) {
            throw new Error('Erro na resposta do servidor: ' + response.status);
          }
          return response.json();
        })
        .then(resultado => rastreadorProcessarListaItens(resultado))
        .catch(erro => rastreadorMostrarErro('Erro ao conectar ao servidor: ' + erro.message));
    }

    function rastreadorProcessarListaItens(resultado) {
        const resultsDiv = document.getElementById('trackerResults');

        if (resultado.erro) {
            rastreadorMostrarErro(resultado.erro);
            document.getElementById('itemSelectionContainer').style.display = 'none';
            return;
        }

        itensDoPedido = resultado.itens || [];
        ultimoResultado = resultado;

        let infoHtml = '<div class="success">‚úÖ Pedido encontrado! Selecione os itens para rastrear.</div>';
        infoHtml += '<div class="order-info">';
        infoHtml += '<div class="info-row">';
        infoHtml += '<div class="info-item">';
        infoHtml += '<div class="info-label">N√∫mero do Pedido</div>';
        infoHtml += '<div class="info-value">' + resultado.numero + '</div>';
        infoHtml += '</div>';
        infoHtml += '<div class="info-item">';
        infoHtml += '<div class="info-label">Cliente</div>';
        infoHtml += '<div class="info-value">' + resultado.cliente + '</div>';
        infoHtml += '</div>';
        infoHtml += '</div>';
        infoHtml += '<div class="info-row">';
        infoHtml += '<div class="info-item">';
        infoHtml += '<div class="info-label">Data de Entrega Prevista</div>';
        infoHtml += '<div class="info-value">' + resultado.entrega + '</div>';
        infoHtml += '</div>';
        infoHtml += '</div>';
        infoHtml += '</div>';
        
        resultsDiv.innerHTML = infoHtml;
        resultsDiv.classList.add('show');
        document.getElementById('downloadGroup').style.display = 'none';

        const itemListDiv = document.getElementById('itemList');
        itemListDiv.innerHTML = '';
        itensDoPedido.forEach((item, index) => {
            itemListDiv.innerHTML += `
                <label>
                    <input type="checkbox" name="item" value="${item}" checked>
                    ${item}
                </label>
            `;
        });

        document.getElementById('itemSelectionContainer').style.display = 'block';
    }

    function rastreadorRastrearItens() {
        const selectedItems = Array.from(document.querySelectorAll('#itemList input[name="item"]:checked'))
                                   .map(checkbox => checkbox.value);

        if (selectedItems.length === 0) {
            rastreadorMostrarErro('Por favor, selecione pelo menos um item para rastrear.');
            return;
        }

        rastreadorMostrarCarregando('Rastreando status dos itens selecionados...');

        fetch(RASTREADOR_WEB_APP_URL + '?action=buscarStatus&numero=' + encodeURIComponent(ultimoNumeroPedido) + '&itens=' + encodeURIComponent(JSON.stringify(selectedItems)))
          .then(response => {
            if (!response.ok) {
              throw new Error('Erro na resposta do servidor: ' + response.status);
            }
            return response.json();
          })
          .then(resultado => rastreadorMostrarResultado(resultado))
          .catch(erro => rastreadorMostrarErro('Erro ao conectar ao servidor: ' + erro.message));
    }
    
    function rastreadorMostrarCarregando(mensagem) {
      const resultsDiv = document.getElementById('trackerResults');
      resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>' + mensagem + '</div>';
      resultsDiv.classList.add('show');
      document.getElementById('itemSelectionContainer').style.display = 'none';
      document.getElementById('downloadGroup').style.display = 'none';
    }
    
    function rastreadorMostrarResultado(resultado) {
      const resultsDiv = document.getElementById('trackerResults');
      
      if (resultado.erro) {
        resultsDiv.innerHTML = '<div class="error">‚ùå ' + resultado.erro + '</div>';
        resultsDiv.classList.add('show');
        document.getElementById('downloadGroup').style.display = 'none';
        return;
      }
      
      ultimoResultado.itensSelecionados = resultado.itensSelecionados;
      ultimoResultado.atualizacoesAgrupadas = resultado.atualizacoesAgrupadas;

      const itensExibicao = resultado.itensSelecionados.join('; ');

      let html = '<div class="success">‚úÖ Rastreamento conclu√≠do para: ' + itensExibicao + '</div>';
      
      html += '<div class="order-info">';
      html += '<div class="info-row">';
      html += '<div class="info-item">';
      html += '<div class="info-label">N√∫mero do Pedido</div>';
      html += '<div class="info-value">' + ultimoResultado.numero + '</div>';
      html += '</div>';
      html += '<div class="info-item">';
      html += '<div class="info-label">Cliente</div>';
      html += '<div class="info-value">' + ultimoResultado.cliente + '</div>';
      html += '</div>';
      html += '</div>';
      
      html += '<div class="info-row">';
      html += '<div class="info-item">';
      html += '<div class="info-label">Data de Entrega Prevista</div>';
      html += '<div class="info-value">' + ultimoResultado.entrega + '</div>';
      html += '</div>';
      html += '<div class="info-item">';
      html += '<div class="info-label">Itens Rastreando</div>';
      html += '<div class="info-value">' + itensExibicao + '</div>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
      
      html += '<div class="timeline">';
      html += '<div class="timeline-title">üìÖ Hist√≥rico de Atualiza√ß√µes</div>';
      
      const itensAgrupados = resultado.atualizacoesAgrupadas;
      const itensOrdenados = Object.keys(itensAgrupados).sort();

      if (itensOrdenados.length === 0) {
          html += '<p>Nenhuma atualiza√ß√£o de status encontrada para os itens selecionados.</p>';
      } else {
          itensOrdenados.forEach(function(item) {
              const atualizacoes = itensAgrupados[item];
              
              html += '<h3 class="item-timeline-title">Item: ' + item + '</h3>';

              atualizacoes.forEach(function(atualizacao) {
                const classe = atualizacao.atrasado ? 'atrasado' : (atualizacao.entregue ? 'entregue' : '');
                const badge = atualizacao.atrasado ? '<span class="tracker-badge badge-atrasado">ATRASADO</span>' : (atualizacao.entregue ? '<span class="tracker-badge badge-entregue">ENTREGUE</span>' : '');
                
                html += '<div class="timeline-item ' + classe + '">';
                html += '<div class="timeline-status">' + atualizacao.status + badge + '</div>';
                html += '<div class="timeline-previsao">' + atualizacao.previsao + '</div>';
                html += '<div class="timeline-motivo">Motivo: ' + atualizacao.motivo + '</div>';
                html += '<div class="timeline-data">' + atualizacao.data + '</div>';
                html += '</div>';
              });
          });
      }
      
      html += '</div>';
      
      resultsDiv.innerHTML = html;
      resultsDiv.classList.add('show');
      document.getElementById('downloadGroup').style.display = 'flex';
      document.getElementById('itemSelectionContainer').style.display = 'none';
    }
    
    function rastreadorMostrarErro(erro) {
      const resultsDiv = document.getElementById('trackerResults');
      resultsDiv.innerHTML = '<div class="error">‚ùå Erro: ' + erro + '</div>';
      resultsDiv.classList.add('show');
      document.getElementById('itemSelectionContainer').style.display = 'none';
      document.getElementById('downloadGroup').style.display = 'none';
    }
    
    function rastreadorLimpar() {
      document.getElementById('orderNumber').value = '';
      document.getElementById('trackerResults').innerHTML = '';
      document.getElementById('trackerResults').classList.remove('show');
      document.getElementById('downloadGroup').style.display = 'none';
      document.getElementById('itemSelectionContainer').style.display = 'none';
      document.getElementById('orderNumber').focus();
      ultimoResultado = null;
      ultimoNumeroPedido = null;
      itensDoPedido = [];
    }
    
    function rastreadorBaixarPDF() {
      if (!ultimoResultado || !ultimoResultado.atualizacoesAgrupadas) {
          rastreadorMostrarErro('Nenhum resultado para baixar. Por favor, rastreie um pedido primeiro.');
          return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 15;
      const lineHeight = 7;
      let yPosition = margin;
      
      const corPrimaria = [0, 71, 171];
      const corSecundaria = [204, 0, 0];
      const corTexto = [51, 51, 51];
      const corTextoClaro = [153, 153, 153];
      
      doc.setFillColor(...corPrimaria);
      doc.rect(0, 0, pageWidth, 30, 'F');
      
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(20);
      doc.setFont(undefined, 'bold');
      doc.text('RASTREADOR DE PEDIDOS', margin + 5, 15);
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text('Relat√≥rio de Acompanhamento', margin + 5, 23);
      
      yPosition = 40;
      
      doc.setTextColor(...corPrimaria);
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('INFORMA√á√ïES DO PEDIDO', margin, yPosition);
      yPosition += 8;
      
      doc.setTextColor(...corTexto);
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      
      const infoData = [
        ['N√∫mero do Pedido:', ultimoResultado.numero],
        ['Cliente:', ultimoResultado.cliente],
        ['Data de Entrega Prevista:', ultimoResultado.entrega],
        ['Itens Rastreados:', ultimoResultado.itensSelecionados.join(', ')]
      ];
      
      infoData.forEach(([label, value]) => {
        if (yPosition > pageHeight - margin - 20) {
          doc.addPage();
          yPosition = margin;
        }
        
        doc.setFont(undefined, 'bold');
        doc.setTextColor(...corPrimaria);
        doc.text(label, margin, yPosition);
        
        doc.setFont(undefined, 'normal');
        doc.setTextColor(...corTexto);
        const textWidth = pageWidth - (margin * 2) - 60;
        const splitText = doc.splitTextToSize(value, textWidth);
        doc.text(splitText, margin + 60, yPosition);
        
        yPosition += lineHeight + 2;
      });
      
      yPosition += 5;
      
      Object.keys(ultimoResultado.atualizacoesAgrupadas).forEach(item => {
        if (yPosition > pageHeight - margin - 15) {
          doc.addPage();
          yPosition = margin;
        }
        
        doc.setTextColor(...corPrimaria);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('Item: ' + item, margin, yPosition);
        yPosition += 8;
        
        ultimoResultado.atualizacoesAgrupadas[item].forEach(atualizacao => {
          if (yPosition > pageHeight - margin - 15) {
            doc.addPage();
            yPosition = margin;
          }
          
          doc.setFillColor(...corPrimaria);
          doc.circle(margin + 5, yPosition + 2, 2.5, 'F');
          
          doc.setFont(undefined, 'bold');
          doc.setTextColor(...corTexto);
          doc.setFontSize(10);
          let statusText = atualizacao.status;
          if (atualizacao.atrasado) statusText += ' [ATRASADO]';
          else if (atualizacao.entregue) statusText += ' [ENTREGUE]';
          doc.text(statusText, margin + 12, yPosition + 2);
          
          yPosition += 5;
          
          doc.setFont(undefined, 'normal');
          doc.setTextColor(...corTextoClaro);
          doc.setFontSize(9);
          doc.text('Previs√£o: ' + atualizacao.previsao, margin + 12, yPosition);
          yPosition += 4;
          
          const motivoText = doc.splitTextToSize('Motivo: ' + atualizacao.motivo, pageWidth - (margin * 2) - 12);
          doc.text(motivoText, margin + 12, yPosition);
          yPosition += (motivoText.length * 3) + 2;
          
          doc.setTextColor(200, 200, 200);
          doc.setFontSize(8);
          doc.text('Data: ' + atualizacao.data, margin + 12, yPosition);
          yPosition += 6;
        });
        
        yPosition += 5;
      });
      
      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setTextColor(200, 200, 200);
        doc.setFontSize(8);
        doc.text(
          'P√°gina ' + i + ' de ' + totalPages + ' | Gerado em ' + new Date().toLocaleString('pt-BR'),
          margin,
          pageHeight - 8
        );
      }
      
      doc.save('Rastreamento_Pedido_' + ultimoNumeroPedido + '.pdf');
    }
  </script>
</body>
</html>

